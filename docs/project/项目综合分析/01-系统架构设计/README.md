# 1. 系统架构设计

## 1.1 系统整体架构

### 1.1.1 架构概述

葛洲坝船闸导航系统采用分层架构设计，主要分为以下几层：

```text
┌─────────────────────────────────────────────────────────┐
│                    业务应用层                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 船闸状态监测 │ │ 显示屏控制   │ │ 速度测量     │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                    控制服务层                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 组件管理器   │ │ 消息中间件   │ │ 配置管理     │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                    驱动服务层                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 雷达驱动     │ │ 云台驱动     │ │ LED驱动      │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                    设备硬件层                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 雷达设备     │ │ 云台设备     │ │ LED显示屏    │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### 1.1.2 核心组件

1. **服务主控组件 (ServiceMasterAdapter)**
   - 负责系统整体生命周期管理
   - 协调各子组件的启动和停止
   - 处理系统级异常

2. **组件管理器 (Cpts)**
   - 管理所有业务组件的生命周期
   - 提供组件注册和发现机制
   - 实现组件间的依赖管理

3. **消息中间件 (NATS)**
   - 实现组件间的异步通信
   - 支持发布-订阅模式
   - 提供可靠的消息传递

## 1.2 组件设计模式

### 1.2.1 组件接口层次

```go
// 基础组件接口
type Cpt interface {
    Start() error
    Stop() error
    IsRunning() bool
    CmptInfo() string
    Ctrl() *mdl.CtrlSt
}

// 组合组件接口
type CptComposite interface {
    Cpt
    Add(cpt Cpt) error
    Remove(cpt Cpt) error
    GetCpt(name string) (Cpt, error)
}

// 根组件接口
type CptRoot interface {
    Cpt
    CptComposite
    Finalize() error
}
```

### 1.2.2 组件生命周期

```text
初始化 → 启动 → 运行 → 停止 → 清理
   ↓       ↓      ↓      ↓      ↓
 创建组件  启动组件  业务处理  停止组件  释放资源
```

### 1.2.3 组件通信模式

1. **同步通信**
   - 直接方法调用
   - 适用于紧耦合的组件

2. **异步通信**
   - 基于NATS的消息传递
   - 适用于松耦合的组件

3. **事件驱动**
   - 状态变更事件
   - 异常事件
   - 业务事件

## 1.3 数据流设计

### 1.3.1 数据流向

```text
设备数据采集 → 驱动处理 → 状态更新 → 业务处理 → 控制指令 → 设备执行
     ↓            ↓          ↓          ↓          ↓          ↓
  原始数据     格式化数据   组件状态    业务逻辑    设备指令    物理动作
```

### 1.3.2 数据存储层次

1. **本地数据库 (LocalDB)**
   - 缓存数据
   - 临时数据
   - 配置数据

2. **生产数据库 (ProduceDB)**
   - 业务数据
   - 历史数据
   - 统计数据

3. **Web数据库 (ProduceWebDB)**
   - 展示数据
   - 报表数据
   - 用户数据

## 1.4 接口设计规范

### 1.4.1 消息主题规范

```text
rt.{location}.{lock}.{id}.{scope}.{system}.{type}.{category}.{device}.{position}.{action}
```

示例：

- `rt.gzb.navl.1.in.sys.cpt.svr.navlstatus.status`
- `rt.gzb.navl.1.in.sys.cpt.dvr.radar.down.right.cmd`

### 1.4.2 接口类型

1. **命令接口 (cmd)**
   - 请求-响应模式
   - 同步执行
   - 返回执行结果

2. **状态接口 (status)**
   - 查询当前状态
   - 同步响应
   - 实时数据

3. **事件接口 (event)**
   - 异步通知
   - 状态变更
   - 异常报告

4. **配置接口 (conf)**
   - 参数设置
   - 配置查询
   - 配置验证

## 1.5 系统集成架构

### 1.5.1 外部系统集成

```text
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   大平台系统     │    │   Web管理系统    │    │   监控系统       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   NATS消息总线   │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   船闸导航系统   │
                    └─────────────────┘
```

### 1.5.2 数据接口规范

1. **上行数据接口**
   - 设备状态数据
   - 业务统计数据
   - 异常告警数据

2. **下行控制接口**
   - 设备控制指令
   - 系统配置参数
   - 业务控制指令

## 1.6 安全架构设计

### 1.6.1 访问控制

1. **身份认证**
   - 基于令牌的认证
   - 支持多种认证方式

2. **权限管理**
   - 基于角色的访问控制
   - 细粒度权限控制

3. **数据安全**
   - 数据传输加密
   - 敏感数据脱敏

### 1.6.2 系统安全

1. **网络安全**
   - 防火墙配置
   - 网络隔离
   - 入侵检测

2. **应用安全**
   - 输入验证
   - SQL注入防护
   - XSS防护

## 1.7 性能架构设计

### 1.7.1 性能指标

1. **响应时间**
   - 设备控制响应 < 100ms
   - 状态查询响应 < 50ms
   - 数据上报延迟 < 1s

2. **吞吐量**
   - 并发设备连接 > 100
   - 消息处理能力 > 1000/s
   - 数据存储能力 > 10000/s

3. **可用性**
   - 系统可用性 > 99.9%
   - 故障恢复时间 < 5分钟
   - 数据丢失率 < 0.01%

### 1.7.2 性能优化

1. **并发处理**
   - 使用goroutine池
   - 异步消息处理
   - 连接池管理

2. **缓存策略**
   - 多级缓存
   - 热点数据缓存
   - 配置数据缓存

3. **资源管理**
   - 内存池
   - 对象复用
   - 垃圾回收优化

## 1.8 扩展性设计

### 1.8.1 水平扩展

1. **组件扩展**
   - 支持动态添加组件
   - 组件热插拔
   - 负载均衡

2. **设备扩展**
   - 支持新设备类型
   - 设备即插即用
   - 设备配置热更新

### 1.8.2 垂直扩展

1. **功能扩展**
   - 插件化架构
   - 模块化设计
   - 接口标准化

2. **业务扩展**
   - 支持新业务场景
   - 配置化业务规则
   - 规则引擎支持
